<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GPTrading Pro Dashboard</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap');
    
    :root {
      --primary: #5a67d8;
      --secondary: #48bb78;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f97316;
      --dark: #1f2937;
      --dark-secondary: #374151;
      --light: #f3f4f6;
      --text: #e5e7eb;
      --text-light: #9ca3af;
      --border: #4b5563;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.25);
      --gradient-primary: linear-gradient(135deg, #5a67d8 0%, #805ad5 100%);
      --gradient-card: linear-gradient(145deg, #2d3748 0%, #1f2937 100%);
    }

    /* Light mode */
    body.light-mode {
      --dark: #f8fafc;
      --dark-secondary: #f1f5f9;
      --text: #1f2937;
      --text-light: #6b7280;
      --border: #e5e7eb;
      --gradient-card: linear-gradient(145deg, #ffffff 0%, #f9fafb 100%);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--dark);
      color: var(--text);
      line-height: 1.6;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .main-container {
      max-width: 1800px;
      margin: 0 auto;
      padding: 30px;
    }

    .header {
      background: var(--gradient-primary);
      border-radius: 25px;
      padding: 50px;
      margin-bottom: 40px;
      text-align: center;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
      animation: shimmer 4s infinite linear;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%) skewX(-20deg); }
      100% { transform: translateX(100%) skewX(-20deg); }
    }

    .header h1 {
      color: white;
      font-size: 3.2rem;
      font-weight: 800;
      margin-bottom: 10px;
      text-shadow: 0 2px 5px rgba(0,0,0,0.4);
    }

    .header p {
      color: rgba(255,255,255,0.9);
      font-size: 1.3rem;
      max-width: 900px;
      margin: 0 auto;
    }

    .controls-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--dark-secondary);
      padding: 25px;
      border-radius: 20px;
      margin-bottom: 40px;
      box-shadow: var(--shadow-lg);
      flex-wrap: wrap;
      gap: 15px;
      transition: background 0.3s ease;
    }
    
    .controls-bar > div {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }

    .btn-sm {
        padding: 8px 16px;
        font-size: 14px;
        border-radius: 8px;
    }

    .btn:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
    }
    
    .btn-warning {
      background: var(--warning);
      color: white;
    }
    
    .btn-icon {
      padding: 12px;
      font-size: 1.2em;
    }

    .card {
      background: var(--gradient-card);
      border-radius: 25px;
      padding: 35px;
      margin-bottom: 30px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      transition: background 0.3s ease, border 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 30px rgba(0,0,0,0.3);
    }

    .card h2, .card h3 {
      color: var(--text);
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card-header-flex {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }
    
    .card-header-flex h2 {
        margin-bottom: 0;
    }


    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
      margin-bottom: 25px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-group label {
      font-weight: 500;
      color: var(--text-light);
      font-size: 15px;
    }

    .form-control {
      padding: 14px 18px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 15px;
      transition: all 0.3s ease;
      background: var(--dark-secondary);
      color: var(--text);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(90, 103, 216, 0.2);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--dark-secondary);
      padding: 25px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      text-align: center;
      position: relative;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
      border: 1px solid var(--border);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    
    .stat-card.profit::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: var(--success);
    }
    .stat-card.loss::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: var(--danger);
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 5px;
    }
    
    .stat-card.profit .stat-value {
      color: var(--success);
    }
    
    .stat-card.loss .stat-value {
      color: var(--danger);
    }

    .stat-label {
      color: var(--text-light);
      font-size: 14px;
      font-weight: 500;
    }
    
    .table-container {
      background: var(--dark-secondary);
      border-radius: 15px;
      overflow-x: auto;
      box-shadow: var(--shadow-lg);
      margin-bottom: 30px;
      border: 1px solid var(--border);
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
    }

    .table th {
      background: #1f2937;
      color: var(--text-light);
      padding: 20px 18px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
    }
    
    .light-mode .table th {
        background: #e5e7eb;
    }

    .table td {
      padding: 18px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
      font-size: 15px;
      color: var(--text);
    }

    .table tbody tr:last-child td {
        border-bottom: none;
    }

    .table tbody tr:hover {
      background: var(--border);
    }
    
    .light-mode .table tbody tr:hover {
      background: #f3f4f6;
    }


    .badge {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      text-transform: capitalize;
    }

    .badge-success {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
    }

    .badge-danger {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
    }

    .chart-container {
      background: var(--dark-secondary);
      padding: 30px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      margin-bottom: 30px;
      border: 1px solid var(--border);
    }

    .calculator-widget {
      background: var(--dark-secondary);
      color: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
    }
    
    .calculator-widget h3 {
        font-size: 1.5rem;
    }

    .calculator-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .calc-result {
      background: rgba(255,255,255,0.05);
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      border: 1px dashed var(--border);
    }

    .notification-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .notification {
        padding: 15px 25px;
        border-radius: 10px;
        color: white;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        opacity: 0;
        transform: translateY(20px);
        animation: fade-in 0.5s ease-out forwards;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .notification.success { background: var(--success); }
    .notification.warning { background: var(--warning); }
    .notification.danger { background: var(--danger); }
    
    @keyframes fade-in {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .grid-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    @media (max-width: 1200px) {
        .grid-container {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 992px) {
        .header h1 {
            font-size: 2.5rem;
        }
        .header p {
            font-size: 1.1rem;
        }
    }
    
    @media (max-width: 768px) {
      .controls-bar {
        flex-direction: column;
        align-items: stretch;
      }
      .controls-bar > div {
        flex-direction: column;
        align-items: center;
      }
      .btn {
        width: 100%;
        justify-content: center;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .header p {
        font-size: 1rem;
      }

      .form-grid, .stats-grid, .calculator-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dark-mode">
  <div class="main-container">
    <div class="header">
      <h1>üìà GPTrading Pro Dashboard</h1>
      <p>Sistema Avanzado de Gesti√≥n de Trading Binario con An√°lisis en Tiempo Real</p>
    </div>

    <div class="controls-bar">
      <div>
        <button class="btn btn-primary" onclick="toggleDarkMode()">üåì Tema</button>
        <button class="btn btn-secondary" onclick="exportToCSV()">üìä Exportar CSV</button>
        <label for="csv-input" class="btn btn-primary" style="margin: 0; cursor: pointer; justify-content: center;">
          <input type="file" id="csv-input" accept=".csv" style="display: none;">
          üìÅ Importar CSV
        </label>
      </div>
      <div>
        <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Limpiar Todo</button>
        <button class="btn btn-warning" onclick="showCalculator()">üßÆ Calculadora</button>
      </div>
    </div>
    
    <div class="card">
        <h2>üìä Resumen de Estad√≠sticas Globales</h2>
        <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="total-initial-capital">$0.00</div>
              <div class="stat-label">Capital Inicial Total</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="total-current-capital">$0.00</div>
              <div class="stat-label">Capital Actual Total</div>
            </div>
            <div class="stat-card profit" id="total-gain-card">
              <div class="stat-value" id="total-gain">$0.00</div>
              <div class="stat-label">Ganancia Total</div>
            </div>
            <div class="stat-card loss" id="total-loss-card">
              <div class="stat-value" id="total-loss">$0.00</div>
              <div class="stat-label">P√©rdida Total</div>
            </div>
            <div class="stat-card" id="net-profit-card">
              <div class="stat-value" id="total-net-profit">$0.00</div>
              <div class="stat-label">Ganancia Neta Total</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="daily-profit">$0.00</div>
              <div class="stat-label">Ganancia Diaria Total</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="success-rate">0%</div>
              <div class="stat-label">Tasa de √âxito Total</div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <h2>üìä Resumen de Ganancia Mensual Dividida (50%) por Cuenta</h2>
        <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); align-items: end;">
            <div class="input-group">
              <label>Seleccionar Cuenta</label>
              <select class="form-control" id="split-profit-account-filter" onchange="updateSplitProfitCard()"></select>
            </div>
            <div class="input-group">
              <label>Seleccionar Mes y A√±o</label>
              <input type="month" class="form-control" id="split-profit-month-filter" onchange="updateSplitProfitCard()">
            </div>
        </div>
        <div class="stats-grid" style="grid-template-columns: 1fr; margin-top: 20px; margin-bottom: 0;">
            <div class="stat-card">
              <div class="stat-value" id="monthly-profit-split">$0.00</div>
              <div class="stat-label">Ganancia Mensual Dividida (50%)</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>üóìÔ∏è Resumen de Ganancias por Periodo Personalizado</h2>
        <div class="form-grid" style="margin-bottom: 20px;">
            <div class="input-group">
                <label>Filtrar por Cuenta</label>
                <select class="form-control" id="custom-period-account-filter">
                    <option value="">Todas las cuentas</option>
                </select>
            </div>
            <div class="input-group">
                <label>Fecha Desde</label>
                <input type="date" class="form-control" id="custom-period-start">
            </div>
            <div class="input-group">
                <label>Fecha Hasta</label>
                <input type="date" class="form-control" id="custom-period-end">
            </div>
            <div class="input-group" style="align-self: flex-end;">
                <button class="btn btn-primary" onclick="renderCustomPeriodSummary()">üîç Generar Resumen</button>
            </div>
        </div>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Periodo</th>
                        <th>Cuenta</th>
                        <th>Ganancia Neta Total</th>
                    </tr>
                </thead>
                <tbody id="custom-period-summary-table">
                    <tr><td colspan="3" style="text-align: center; color: var(--text-light);">Seleccione filtros para generar un resumen.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="card">
        <h2>üè¶ Resumen de Estad√≠sticas por Cuenta</h2>
        <div id="account-stats-summary"></div>
    </div>

    <div class="calculator-widget" id="calculator-widget" style="display: none;">
      <h3>üßÆ Calculadora de Porcentajes Avanzada</h3>
      <div class="calculator-grid">
        <div class="input-group">
          <label>Capital Inicial ($)</label>
          <input type="number" class="form-control" id="calc-initial" placeholder="1000">
        </div>
        <div class="input-group">
          <label>Capital Final ($)</label>
          <input type="number" class="form-control" id="calc-final" placeholder="1200">
        </div>
      </div>
      <button class="btn btn-success" onclick="calculateProfit()" style="margin-top: 20px;">Calcular Rendimiento</button>
      <div class="calc-result" id="calc-result" style="display: none;">
        <h4>Resultados del An√°lisis:</h4>
        <p id="profit-amount"></p>
        <p id="profit-percentage"></p>
        <p id="profit-analysis"></p>
      </div>
    </div>

    <div class="card grid-container">
      <div>
        <h2>‚ûï Agregar Nueva Operaci√≥n</h2>
        <div class="form-grid">
          <div class="input-group">
            <label>Cuenta</label>
            <select class="form-control" id="account-select">
              <option value="">Seleccionar cuenta</option>
            </select>
          </div>
          <div class="input-group">
            <label>Fecha</label>
            <input type="date" class="form-control" id="input-date">
          </div>
          <div class="input-group">
            <label>Operaciones Ganadas</label>
            <input type="number" class="form-control" id="input-win" placeholder="5" min="0">
          </div>
          <div class="input-group">
            <label>Operaciones Perdidas</label>
            <input type="number" class="form-control" id="input-loss" placeholder="2" min="0">
          </div>
          <div class="input-group">
            <label>Ganancia ($)</label>
            <input type="number" class="form-control" id="input-gain" placeholder="300.00" step="0.01" min="0">
          </div>
          <div class="input-group">
            <label>P√©rdida ($)</label>
            <input type="number" class="form-control" id="input-loss-amount" placeholder="50.00" step="0.01" min="0">
          </div>
        </div>
        <button class="btn btn-success" onclick="addOperation()">‚úÖ Agregar Operaci√≥n</button>
      </div>
      
      <div>
        <h2>üè¶ Gesti√≥n de Cuentas</h2>
        <div class="form-grid">
          <div class="input-group">
            <label>Nombre de la Cuenta</label>
            <input type="text" class="form-control" id="new-account-name" placeholder="Mi Cuenta Principal">
          </div>
          <div class="input-group">
            <label>Capital Inicial ($)</label>
            <input type="number" class="form-control" id="new-account-balance" placeholder="1000.00" step="0.01" min="0">
          </div>
        </div>
        <button class="btn btn-primary" onclick="addAccount()">üè¶ Crear Cuenta</button>
      </div>
    </div>
    
    <div class="card">
      <h2>üîç Filtros y B√∫squeda</h2>
      <div class="form-grid">
        <div class="input-group">
          <label>Filtrar por Cuenta</label>
          <select class="form-control" id="filter-account">
            <option value="">Todas las cuentas</option>
          </select>
        </div>
        <div class="input-group">
          <label>Fecha Desde</label>
          <input type="date" class="form-control" id="filter-start">
        </div>
        <div class="input-group">
          <label>Fecha Hasta</label>
          <input type="date" class="form-control" id="filter-end">
        </div>
        <div class="input-group" style="align-self: flex-end;">
          <button class="btn btn-primary" onclick="applyFilters()">üîç Aplicar Filtros</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 id="daily-report-title">üóìÔ∏è Resumen de Operaciones</h2>
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Cuenta</th>
              <th>Ganadas</th>
              <th>Perdidas</th>
              <th>Ganancia ($)</th>
              <th>P√©rdida ($)</th>
              <th>Neto ($)</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="daily-operations-table">
          </tbody>
        </table>
      </div>
    </div>
    
    <div class="card" id="operations-history-card">
        <div class="card-header-flex">
            <h2>üìú Historial Completo de Operaciones</h2>
            <button id="toggle-history-btn" class="btn btn-warning btn-sm" onclick="toggleOperationsHistory()">Ocultar</button>
        </div>
        <div id="operations-history-content">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Cuenta</th>
                            <th>Fecha</th>
                            <th>Ganadas</th>
                            <th>Perdidas</th>
                            <th>Ganancia ($)</th>
                            <th>P√©rdida ($)</th>
                            <th>Neto ($)</th>
                            <th>Rendimiento (%)</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="operations-table">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card" id="profit-chart-card">
        <h2>üìà An√°lisis de Rendimiento</h2>
        <div class="chart-container">
            <canvas id="profitChart"></canvas>
        </div>
    </div>

    <div class="card" id="monthly-chart-card">
        <h2>üìä Evoluci√≥n Mensual</h2>
        <div class="chart-container">
            <canvas id="monthlyChart"></canvas>
        </div>
    </div>
  </div>
  
  <div id="notification-container" class="notification-container"></div>

  <script>
    const STORAGE_KEYS = {
      operations: 'gp_trading_operations_v3',
      accounts: 'gp_trading_accounts_v3',
      operations_old: 'gp_trading_operations',
      accounts_old: 'gp_trading_accounts',
    };

    let profitChart, monthlyChart;
    
    const generateUniqueId = () => {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    };

    const formatCurrency = (amount) => {
      return new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 2
      }).format(amount);
    };

    const formatPercentage = (value) => {
      return `${value.toFixed(2)}%`;
    };

    const getTodayDate = () => {
      const date = new Date();
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    };

    const getCurrentMonth = () => {
      return new Date().toISOString().slice(0, 7);
    };
    
    const showNotification = (message, type) => {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `<span>${message}</span>`;
        container.appendChild(notification);
        setTimeout(() => {
            notification.style.opacity = 0;
            notification.style.transform = 'translateY(20px)';
            setTimeout(() => notification.remove(), 500);
        }, 5000);
    };

    const loadData = (key) => {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : [];
      } catch (error) {
        console.error('Error loading data:', error);
        return [];
      }
    };

    const saveData = (key, data) => {
      try {
        localStorage.setItem(key, JSON.stringify(data));
      } catch (error) {
        console.error('Error saving data:', error);
        showNotification('Error al guardar los datos. Verifica el espacio disponible.', 'danger');
      }
    };

    const migrateData = () => {
      let oldOperations = loadData(STORAGE_KEYS.operations_old);
      let oldAccounts = loadData(STORAGE_KEYS.accounts_old);
      
      if (oldOperations.length > 0 || oldAccounts.length > 0) {
        if (oldOperations.length > 0) {
          saveData(STORAGE_KEYS.operations, oldOperations);
          localStorage.removeItem(STORAGE_KEYS.operations_old);
          console.log('Operaciones migradas exitosamente.');
        }
        
        if (oldAccounts.length > 0) {
          const migratedAccounts = oldAccounts.map(acc => ({
            ...acc,
            lastReportDate: acc.lastReportDate || new Date().toISOString().split('T')[0]
          }));
          saveData(STORAGE_KEYS.accounts, migratedAccounts);
          localStorage.removeItem(STORAGE_KEYS.accounts_old);
          console.log('Cuentas migradas exitosamente.');
        }
        
        showNotification('‚úÖ Datos de versi√≥n anterior migrados exitosamente', 'success');
        refreshAll();
      }
    };

    const addAccount = () => {
      const name = document.getElementById('new-account-name').value.trim();
      const balance = parseFloat(document.getElementById('new-account-balance').value) || 0;

      if (!name) {
        showNotification('‚ö†Ô∏è Por favor ingresa un nombre para la cuenta', 'warning');
        return;
      }

      if (balance < 0) {
        showNotification('‚ö†Ô∏è El capital inicial debe ser mayor o igual a 0', 'warning');
        return;
      }

      const accounts = loadData(STORAGE_KEYS.accounts);
      
      if (accounts.find(acc => acc.name.toLowerCase() === name.toLowerCase())) {
        showNotification('‚ö†Ô∏è Ya existe una cuenta con ese nombre', 'warning');
        return;
      }

      const newAccount = {
        id: generateUniqueId(),
        name,
        initialBalance: balance,
        currentBalance: balance,
        createdAt: new Date().toISOString(),
      };
      
      accounts.push(newAccount);

      saveData(STORAGE_KEYS.accounts, accounts);
      updateAccountSelects();
      clearAccountForm();
      showNotification('‚úÖ Cuenta creada exitosamente', 'success');
      refreshAll();
    };
    
    const deleteAccount = (accountId) => {
        let accounts = loadData(STORAGE_KEYS.accounts);
        const accountToDelete = accounts.find(acc => acc.id === accountId);

        if (!accountToDelete) {
            showNotification('‚ö†Ô∏è No se encontr√≥ la cuenta a eliminar. Por favor, recargue la p√°gina si el problema persiste.', 'danger');
            return;
        }

        if (!confirm(`¬øEst√°s seguro de que quieres eliminar la cuenta "${accountToDelete.name}"?\n¬°ATENCI√ìN! Se eliminar√°n tambi√©n TODAS las operaciones asociadas a esta cuenta. Esta acci√≥n es irreversible.`)) {
            return;
        }

        const updatedAccounts = accounts.filter(acc => acc.id !== accountId);
        saveData(STORAGE_KEYS.accounts, updatedAccounts);

        let operations = loadData(STORAGE_KEYS.operations);
        const updatedOperations = operations.filter(op => op.account !== accountToDelete.name);
        saveData(STORAGE_KEYS.operations, updatedOperations);
        
        showNotification(`üóëÔ∏è Cuenta "${accountToDelete.name}" y sus operaciones han sido eliminadas.`, 'success');
        refreshAll();
    };

    const updateAccount = (accountId) => {
        let accounts = loadData(STORAGE_KEYS.accounts);
        let operations = loadData(STORAGE_KEYS.operations);
        const accountIndex = accounts.findIndex(acc => acc.id === accountId);

        if (accountIndex === -1) {
            showNotification('‚ö†Ô∏è No se encontr√≥ la cuenta a actualizar.', 'danger');
            return;
        }

        const accountToUpdate = accounts[accountIndex];
        const oldName = accountToUpdate.name;

        const newName = prompt("Ingresa el nuevo nombre para la cuenta:", oldName);
        if (newName === null) return;
        if (newName.trim() === "") {
            showNotification("‚ö†Ô∏è El nombre de la cuenta no puede estar vac√≠o.", "warning");
            return;
        }
        
        if (accounts.some(acc => acc.name.toLowerCase() === newName.trim().toLowerCase() && acc.id !== accountId)) {
            showNotification("‚ö†Ô∏è Ya existe otra cuenta con ese nombre.", "warning");
            return;
        }

        const newInitialBalanceStr = prompt("Ingresa el nuevo capital inicial:", accountToUpdate.initialBalance);
        if (newInitialBalanceStr === null) return;
        
        const newInitialBalance = parseFloat(newInitialBalanceStr);
        if (isNaN(newInitialBalance) || newInitialBalance < 0) {
            showNotification("‚ö†Ô∏è El capital inicial debe ser un n√∫mero v√°lido mayor o igual a cero.", "warning");
            return;
        }

        accountToUpdate.name = newName.trim();
        accountToUpdate.initialBalance = newInitialBalance;
        
        if (oldName !== newName.trim()) {
            operations.forEach(op => {
                if (op.account === oldName) {
                    op.account = newName.trim();
                }
            });
            saveData(STORAGE_KEYS.operations, operations);
        }

        saveData(STORAGE_KEYS.accounts, accounts);
        
        recalculateAccountBalances();
        showNotification(`‚úÖ Cuenta "${newName.trim()}" actualizada exitosamente.`, 'success');
        refreshAll();
    };

    const clearAccountForm = () => {
      document.getElementById('new-account-name').value = '';
      document.getElementById('new-account-balance').value = '';
    };

    const addOperation = () => {
      const accountName = document.getElementById('account-select').value;
      const date = document.getElementById('input-date').value;
      const wins = parseInt(document.getElementById('input-win').value) || 0;
      const losses = parseInt(document.getElementById('input-loss').value) || 0;
      const gain = parseFloat(document.getElementById('input-gain').value) || 0;
      const lossAmount = parseFloat(document.getElementById('input-loss-amount').value) || 0;

      if (!accountName) {
          showNotification('‚ö†Ô∏è Por favor selecciona una cuenta', 'warning');
          return;
      }
      if (!date) {
          showNotification('‚ö†Ô∏è Por favor ingresa una fecha', 'warning');
          return;
      }
      if (wins === 0 && losses === 0) {
          showNotification('‚ö†Ô∏è Debes ingresar al menos una operaci√≥n ganada o perdida', 'warning');
          return;
      }
      if (wins > 0 && gain === 0) {
          if (!confirm('‚ö†Ô∏è Tienes operaciones ganadas pero no especificaste ganancia. ¬øContinuar?')) return;
      }
      if (losses > 0 && lossAmount === 0) {
          if (!confirm('‚ö†Ô∏è Tienes operaciones perdidas pero no especificaste p√©rdida. ¬øContinuar?')) return;
      }

      const operations = loadData(STORAGE_KEYS.operations);
      const netProfit = gain - lossAmount;
      const accounts = loadData(STORAGE_KEYS.accounts);
      const selectedAccount = accounts.find(acc => acc.name === accountName);
      if (!selectedAccount) {
          showNotification('‚ö†Ô∏è Cuenta no encontrada', 'danger');
          return;
      }

      const previousOperations = operations.filter(op => op.account === accountName && op.date < date);
      let balanceBeforeDay = selectedAccount.initialBalance;
      previousOperations.forEach(op => {
          balanceBeforeDay += (op.netProfit !== undefined ? op.netProfit : (op.gain || 0) - (op.lossAmount || 0));
      });

      const operationsToday = operations.filter(op => op.account === accountName && op.date === date);
      let balanceBeforeOp = balanceBeforeDay;
      operationsToday.forEach(op => {
          balanceBeforeOp += (op.netProfit !== undefined ? op.netProfit : (op.gain || 0) - (op.lossAmount || 0));
      });

      const totalOperations = wins + losses;
      const successRate = totalOperations > 0 ? (wins / totalOperations) * 100 : 0;
      const profitPercentage = balanceBeforeOp > 0 ? (netProfit / balanceBeforeOp) * 100 : 0;
      const newOperation = {
        id: generateUniqueId(),
        account: accountName,
        date,
        wins,
        losses,
        gain,
        lossAmount,
        netProfit,
        successRate,
        profitPercentage,
        totalOperations,
        createdAt: new Date().toISOString()
      };
      operations.push(newOperation);
      saveData(STORAGE_KEYS.operations, operations);
      recalculateAccountBalances();
      clearOperationForm();
      refreshAll();
      showNotification('‚úÖ Operaci√≥n agregada exitosamente', 'success');
    };

    const recalculateAccountBalances = () => {
      const accounts = loadData(STORAGE_KEYS.accounts);
      const operations = loadData(STORAGE_KEYS.operations);
      accounts.forEach(account => {
        let currentBalance = account.initialBalance;
        const accountOperations = operations.filter(op => op.account === account.name).sort((a, b) => new Date(a.date) - new Date(b.date));
        accountOperations.forEach(op => {
          const netProfit = op.netProfit !== undefined ? op.netProfit : (op.gain || 0) - (op.lossAmount || 0);
          currentBalance += netProfit;
        });
        account.currentBalance = currentBalance;
      });
      saveData(STORAGE_KEYS.accounts, accounts);
    };

    const clearOperationForm = () => {
      document.getElementById('input-date').value = getTodayDate();
      document.getElementById('input-win').value = '';
      document.getElementById('input-loss').value = '';
      document.getElementById('input-gain').value = '';
      document.getElementById('input-loss-amount').value = '';
      document.getElementById('account-select').selectedIndex = 0;
    };

    const deleteOperation = (operationId) => {
      if (!confirm('¬øEst√°s seguro de eliminar esta operaci√≥n? Esta acci√≥n es irreversible.')) return;
      const operations = loadData(STORAGE_KEYS.operations);
      const operationIndex = operations.findIndex(op => op.id === operationId);
      if (operationIndex === -1) return;
      operations.splice(operationIndex, 1);
      saveData(STORAGE_KEYS.operations, operations);
      recalculateAccountBalances();
      refreshAll();
      showNotification('üóëÔ∏è Operaci√≥n eliminada exitosamente', 'success');
    };

    const importFromCSV = (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
          const text = e.target.result;
          const lines = text.split('\n').filter(line => line.trim() !== '');

          if (lines.length <= 1) {
              showNotification('‚ö†Ô∏è El archivo CSV est√° vac√≠o o solo contiene encabezados.', 'warning');
              return;
          }

          const header = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
          const requiredHeaders = ['Cuenta', 'Fecha', 'Ganadas', 'Perdidas', 'Ganancia ($)', 'P√©rdida ($)', 'Balance Inicial Dia ($)'];
          const hasAllRequiredHeaders = requiredHeaders.every(h => header.includes(h));

          if (!hasAllRequiredHeaders) {
              showNotification(`‚ö†Ô∏è Encabezados requeridos faltantes: ${requiredHeaders.filter(h => !header.includes(h)).join(', ')}`, 'danger');
              return;
          }

          handleOperationsImport(lines, header);
      };
      reader.readAsText(file);
    };

    const handleOperationsImport = (lines, header) => {
        let accounts = loadData(STORAGE_KEYS.accounts);
        let operations = loadData(STORAGE_KEYS.operations);
        const importedAccountNames = new Set();
        const headerMap = {};
        header.forEach((h, i) => headerMap[h] = i);

        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line === '') continue;
            const parts = line.split(',');
            const accountName = parts[headerMap['Cuenta']].replace(/"/g, '').trim();
            const date = parts[headerMap['Fecha']].trim();
            const wins = parseInt(parts[headerMap['Ganadas']], 10) || 0;
            const losses = parseInt(parts[headerMap['Perdidas']], 10) || 0;
            const gain = parseFloat(parts[headerMap['Ganancia ($)']]) || 0;
            const lossAmount = parseFloat(parts[headerMap['P√©rdida ($)']]) || 0;

            if (isNaN(wins) || isNaN(losses) || isNaN(gain) || isNaN(lossAmount) || !accountName || !date) {
                console.error('L√≠nea de CSV inv√°lida o incompleta:', line);
                continue;
            }

            importedAccountNames.add(accountName);
            const netProfit = gain - lossAmount;
            
            const operationExists = operations.some(op => op.account === accountName && op.date === date && op.gain === gain && op.lossAmount === lossAmount);
            
            if (!operationExists) {
              operations.push({
                  id: generateUniqueId(),
                  account: accountName,
                  date,
                  wins,
                  losses,
                  gain,
                  lossAmount,
                  netProfit,
                  successRate: 0,
                  profitPercentage: 0,
                  totalOperations: wins + losses,
                  createdAt: new Date().toISOString()
              });
            }
        }

        if (importedAccountNames.size === 0) {
            showNotification('‚ö†Ô∏è No se encontraron operaciones v√°lidas en el archivo CSV.', 'warning');
            return;
        }

        importedAccountNames.forEach(accountName => {
            let existingAccount = accounts.find(acc => acc.name === accountName);
            const initialBalanceFromCsv = parseFloat(lines.find(l => l.includes(accountName)).split(',')[headerMap['Balance Inicial Dia ($)']]) || 0;

            if (!existingAccount) {
                accounts.push({
                    id: generateUniqueId(),
                    name: accountName,
                    initialBalance: initialBalanceFromCsv,
                    currentBalance: initialBalanceFromCsv,
                    createdAt: new Date().toISOString()
                });
            }
        });
        
        saveData(STORAGE_KEYS.operations, operations);
        saveData(STORAGE_KEYS.accounts, accounts);
        
        recalculateAccountBalances();
        refreshAll();
        showNotification('‚úÖ Datos importados exitosamente.', 'success');
    };

    const exportToCSV = () => {
      const accounts = loadData(STORAGE_KEYS.accounts);
      const operations = loadData(STORAGE_KEYS.operations);

      if (accounts.length === 0 || operations.length === 0) {
          showNotification('‚ö†Ô∏è No hay datos para exportar.', 'warning');
          return;
      }
      
      let csvContent = "Cuenta,Fecha,Ganadas,Perdidas,Ganancia ($),P√©rdida ($),Neto ($),Balance Inicial Dia ($)\n";

      accounts.forEach(account => {
        let balanceBeforeDay = account.initialBalance;
        const accountOperations = operations.filter(op => op.account === account.name).sort((a, b) => new Date(a.date) - new Date(b.date));

        accountOperations.forEach(op => {
          const netProfit = op.netProfit !== undefined ? op.netProfit : (op.gain || 0) - (op.lossAmount || 0);
          csvContent += `"${op.account}","${op.date}",${op.wins},${op.losses},${op.gain},${op.lossAmount},${op.netProfit},${balanceBeforeDay}\n`;
          balanceBeforeDay += netProfit;
        });
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      if (link.download !== undefined) {
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute("download", "resumen_operaciones.csv");
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          showNotification('‚úÖ Datos exportados a CSV exitosamente', 'success');
      }
    };
    
    const applyFilters = () => {
        const operations = loadData(STORAGE_KEYS.operations);
        const accountFilter = document.getElementById('filter-account').value;
        const startDateFilter = document.getElementById('filter-start').value;
        const endDateFilter = document.getElementById('filter-end').value;

        let filteredOperations = operations;
        
        if (accountFilter) {
            filteredOperations = filteredOperations.filter(op => op.account === accountFilter);
        }
        if (startDateFilter) {
            filteredOperations = filteredOperations.filter(op => op.date >= startDateFilter);
        }
        if (endDateFilter) {
            filteredOperations = filteredOperations.filter(op => op.date <= endDateFilter);
        }
        
        renderFilteredTable(filteredOperations);
    };

    const renderFilteredTable = (filteredOperations) => {
        const tableBody = document.getElementById('operations-table');
        tableBody.innerHTML = '';
        if (filteredOperations.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: var(--text-light);">No se encontraron operaciones con los filtros seleccionados.</td></tr>';
            return;
        }

        filteredOperations.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(op => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${op.account}</td>
                <td>${op.date}</td>
                <td>${op.wins}</td>
                <td>${op.losses}</td>
                <td>${formatCurrency(op.gain)}</td>
                <td>${formatCurrency(op.lossAmount)}</td>
                <td><span class="badge ${op.netProfit >= 0 ? 'badge-success' : 'badge-danger'}">${formatCurrency(op.netProfit)}</span></td>
                <td>${formatPercentage(op.profitPercentage)}</td>
                <td><span class="badge ${op.netProfit >= 0 ? 'badge-success' : 'badge-danger'}">${op.netProfit >= 0 ? 'Ganancia' : 'P√©rdida'}</span></td>
                <td><button class="btn btn-danger btn-sm" onclick="deleteOperation('${op.id}')">üóëÔ∏è</button></td>
            `;
        });
    };

    const clearAllData = () => {
      if (confirm('¬øEst√°s seguro de que quieres limpiar TODOS los datos? Esta acci√≥n es irreversible.')) {
        localStorage.clear();
        showNotification('üóëÔ∏è Todos los datos han sido eliminados.', 'success');
        refreshAll();
      }
    };
    
    const calculateProfit = () => {
      const initial = parseFloat(document.getElementById('calc-initial').value);
      const final = parseFloat(document.getElementById('calc-final').value);
      const resultDiv = document.getElementById('calc-result');
      const profitAmountP = document.getElementById('profit-amount');
      const profitPercentageP = document.getElementById('profit-percentage');
      const profitAnalysisP = document.getElementById('profit-analysis');

      if (isNaN(initial) || isNaN(final)) {
          showNotification('‚ö†Ô∏è Por favor, ingresa valores num√©ricos v√°lidos.', 'warning');
          resultDiv.style.display = 'none';
          return;
      }
      
      const profitAmount = final - initial;
      const profitPercentage = initial > 0 ? (profitAmount / initial) * 100 : 0;
      
      let analysisText = '';
      if (profitPercentage > 0) {
          analysisText = `¬°Excelente! Has obtenido una ganancia del ${formatPercentage(profitPercentage)}.`;
          profitAnalysisP.style.color = 'var(--success)';
      } else if (profitPercentage < 0) {
          analysisText = `¬°Atenci√≥n! Has tenido una p√©rdida del ${formatPercentage(profitPercentage)}.`;
          profitAnalysisP.style.color = 'var(--danger)';
      } else {
          analysisText = 'No se ha registrado ganancia ni p√©rdida.';
          profitAnalysisP.style.color = 'var(--text-light)';
      }

      profitAmountP.textContent = `Ganancia/P√©rdida: ${formatCurrency(profitAmount)}`;
      profitPercentageP.textContent = `Rendimiento (%): ${formatPercentage(profitPercentage)}`;
      profitAnalysisP.textContent = analysisText;
      resultDiv.style.display = 'block';
    };

    const updateAccountSelects = () => {
      const accounts = loadData(STORAGE_KEYS.accounts);
      const selectElements = [
        document.getElementById('account-select'),
        document.getElementById('filter-account'),
        document.getElementById('custom-period-account-filter'),
        document.getElementById('split-profit-account-filter'),
      ];

      selectElements.forEach(select => {
        const currentSelectedValue = select.value;
        select.innerHTML = '';
        
        if (select.id === 'account-select') {
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = 'Seleccionar cuenta';
          select.appendChild(defaultOption);
        } else {
          const allOption = document.createElement('option');
          allOption.value = '';
          allOption.textContent = 'Todas las cuentas';
          select.appendChild(allOption);
        }
        
        accounts.forEach(account => {
          const option = document.createElement('option');
          option.value = account.name;
          option.textContent = account.name;
          select.appendChild(option);
        });

        if (currentSelectedValue && accounts.some(acc => acc.name === currentSelectedValue)) {
            select.value = currentSelectedValue;
        } else if (select.id === 'account-select' && accounts.length > 0) {
            select.selectedIndex = 1;
        }
      });
    };

    const renderAccountStatsSummary = () => {
        const accounts = loadData(STORAGE_KEYS.accounts);
        const operations = loadData(STORAGE_KEYS.operations);
        const container = document.getElementById('account-stats-summary');
        container.innerHTML = '';

        if (accounts.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No hay cuentas registradas. Crea una para empezar.</p>';
            return;
        }

        accounts.forEach(account => {
            const accountOperations = operations.filter(op => op.account === account.name);
            const totalWins = accountOperations.reduce((sum, op) => sum + (op.wins || 0), 0);
            const totalLosses = accountOperations.reduce((sum, op) => sum + (op.losses || 0), 0);
            const totalGain = accountOperations.reduce((sum, op) => sum + (op.gain || 0), 0);
            const totalLossAmount = accountOperations.reduce((sum, op) => sum + (op.lossAmount || 0), 0);
            const netProfit = totalGain - totalLossAmount;
            const successRate = (totalWins + totalLosses) > 0 ? (totalWins / (totalWins + totalLosses)) * 100 : 0;
            const profitPercentage = account.initialBalance > 0 ? (netProfit / account.initialBalance) * 100 : 0;
            const profitClass = netProfit >= 0 ? 'profit' : 'loss';

            const accountDiv = document.createElement('div');
            accountDiv.className = 'card';
            accountDiv.innerHTML = `
                <h3 style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; color: var(--text);">
                    <span>${account.name}</span>
                    <div style="display:flex; gap: 8px;">
                        <button class="btn btn-warning btn-icon" onclick="updateAccount('${account.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-icon" onclick="deleteAccount('${account.id}')">üóëÔ∏è</button>
                    </div>
                </h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${formatCurrency(account.initialBalance)}</div>
                        <div class="stat-label">Capital Inicial</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${formatCurrency(account.currentBalance)}</div>
                        <div class="stat-label">Capital Actual</div>
                    </div>
                    <div class="stat-card ${profitClass}">
                        <div class="stat-value">${formatCurrency(netProfit)}</div>
                        <div class="stat-label">Ganancia Neta</div>
                    </div>
                    <div class="stat-card ${profitClass}">
                        <div class="stat-value">${formatPercentage(profitPercentage)}</div>
                        <div class="stat-label">Rendimiento (%)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalWins}</div>
                        <div class="stat-label">Operaciones Ganadas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalLosses}</div>
                        <div class="stat-label">Operaciones Perdidas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${formatPercentage(successRate)}</div>
                        <div class="stat-label">Tasa de √âxito</div>
                    </div>
                </div>
            `;
            container.appendChild(accountDiv);
        });
    };
    
    const updateGlobalStats = () => {
        const accounts = loadData(STORAGE_KEYS.accounts);
        const operations = loadData(STORAGE_KEYS.operations);

        let totalInitialCapital = 0;
        let totalCurrentCapital = 0;
        let totalGain = 0;
        let totalLoss = 0;
        let totalWins = 0;
        let totalLosses = 0;

        accounts.forEach(acc => {
            totalInitialCapital += acc.initialBalance;
            totalCurrentCapital += acc.currentBalance;
        });

        operations.forEach(op => {
            totalGain += (op.gain || 0);
            totalLoss += (op.lossAmount || 0);
            totalWins += (op.wins || 0);
            totalLosses += (op.losses || 0);
        });

        const totalNetProfit = totalGain - totalLoss;
        const totalSuccessRate = (totalWins + totalLosses) > 0 ? (totalWins / (totalWins + totalLosses)) * 100 : 0;
        
        document.getElementById('total-initial-capital').textContent = formatCurrency(totalInitialCapital);
        document.getElementById('total-current-capital').textContent = formatCurrency(totalCurrentCapital);
        document.getElementById('total-gain').textContent = formatCurrency(totalGain);
        document.getElementById('total-loss').textContent = formatCurrency(totalLoss);
        
        const netProfitElement = document.getElementById('total-net-profit');
        const netProfitCard = document.getElementById('net-profit-card');
        netProfitElement.textContent = formatCurrency(totalNetProfit);
        if (totalNetProfit > 0) {
            netProfitCard.className = 'stat-card profit';
        } else if (totalNetProfit < 0) {
            netProfitCard.className = 'stat-card loss';
        } else {
            netProfitCard.className = 'stat-card';
        }
        
        document.getElementById('success-rate').textContent = formatPercentage(totalSuccessRate);
        
        updateDailyProfit();
    };

    const updateDailyProfit = () => {
      const operations = loadData(STORAGE_KEYS.operations);
      const today = getTodayDate();
      
      const dailyOperations = operations.filter(op => op.date === today);
      
      const dailyProfit = dailyOperations.reduce((sum, op) => sum + op.netProfit, 0);
      
      document.getElementById('daily-profit').textContent = formatCurrency(dailyProfit);
      
      const dailyProfitCard = document.getElementById('daily-profit').closest('.stat-card');
      if (dailyProfit > 0) dailyProfitCard.className = 'stat-card profit';
      else if (dailyProfit < 0) dailyProfitCard.className = 'stat-card loss';
      else dailyProfitCard.className = 'stat-card';
    };

    const renderDailyOperations = () => {
      const operations = loadData(STORAGE_KEYS.operations);
      const today = getTodayDate();
      const tableBody = document.getElementById('daily-operations-table');
      document.getElementById('daily-report-title').textContent = `üóìÔ∏è Resumen de Operaciones - ${today}`;
      tableBody.innerHTML = '';
      
      const dailyOperationsGrouped = operations.filter(op => op.date === today).reduce((acc, op) => {
          if (!acc[op.account]) {
              acc[op.account] = { wins: 0, losses: 0, gain: 0, lossAmount: 0, netProfit: 0, operations: [] };
          }
          acc[op.account].wins += op.wins;
          acc[op.account].losses += op.losses;
          acc[op.account].gain += op.gain;
          acc[op.account].lossAmount += op.lossAmount;
          acc[op.account].netProfit += op.netProfit;
          acc[op.account].operations.push(op);
          return acc;
      }, {});

      if (Object.keys(dailyOperationsGrouped).length === 0) {
          tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-light);">No hay operaciones registradas para hoy.</td></tr>';
          return;
      }
      
      for (const accountName in dailyOperationsGrouped) {
          const group = dailyOperationsGrouped[accountName];
          const row = tableBody.insertRow();
          const netProfitClass = group.netProfit >= 0 ? 'badge-success' : 'badge-danger';
          const operationsHtml = group.operations.map(op => `
              <button class="btn btn-danger btn-icon" onclick="deleteOperation('${op.id}')">üóëÔ∏è</button>
          `).join('');

          row.innerHTML = `
              <td>${accountName}</td>
              <td>${group.wins}</td>
              <td>${group.losses}</td>
              <td>${formatCurrency(group.gain)}</td>
              <td>${formatCurrency(group.lossAmount)}</td>
              <td><span class="badge ${netProfitClass}">${formatCurrency(group.netProfit)}</span></td>
              <td style="white-space: nowrap;">${operationsHtml}</td>
          `;
      }
    };
    
    const renderCustomPeriodSummary = () => {
      const operations = loadData(STORAGE_KEYS.operations);
      const tableBody = document.getElementById('custom-period-summary-table');
      const accountFilter = document.getElementById('custom-period-account-filter').value;
      const startDateFilter = document.getElementById('custom-period-start').value;
      const endDateFilter = document.getElementById('custom-period-end').value;
      
      let filteredOperations = operations;
      
      if (accountFilter) {
          filteredOperations = filteredOperations.filter(op => op.account === accountFilter);
      }
      if (startDateFilter) {
          filteredOperations = filteredOperations.filter(op => op.date >= startDateFilter);
      }
      if (endDateFilter) {
          filteredOperations = filteredOperations.filter(op => op.date <= endDateFilter);
      }
      
      const summary = filteredOperations.reduce((acc, op) => {
        const key = op.account;
        if (!acc[key]) {
            acc[key] = { netProfit: 0, startDate: op.date, endDate: op.date };
        }
        acc[key].netProfit += op.netProfit;
        if (op.date < acc[key].startDate) acc[key].startDate = op.date;
        if (op.date > acc[key].endDate) acc[key].endDate = op.date;
        return acc;
      }, {});
      
      tableBody.innerHTML = '';
      if (Object.keys(summary).length === 0) {
          tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-light);">No se encontraron operaciones en el periodo seleccionado.</td></tr>';
          return;
      }
      
      for (const accountName in summary) {
          const data = summary[accountName];
          const row = tableBody.insertRow();
          const netProfitClass = data.netProfit >= 0 ? 'badge-success' : 'badge-danger';
          row.innerHTML = `
              <td>${data.startDate} a ${data.endDate}</td>
              <td>${accountName}</td>
              <td><span class="badge ${netProfitClass}">${formatCurrency(data.netProfit)}</span></td>
          `;
      }
    };
    
    const updateSplitProfitCard = () => {
        const operations = loadData(STORAGE_KEYS.operations);
        const accountFilter = document.getElementById('split-profit-account-filter').value;
        const monthFilter = document.getElementById('split-profit-month-filter').value;
        const splitProfitElement = document.getElementById('monthly-profit-split');

        if (!accountFilter || !monthFilter) {
            splitProfitElement.textContent = formatCurrency(0);
            return;
        }

        const filteredOperations = operations.filter(op => op.account === accountFilter && op.date.startsWith(monthFilter));
        const totalProfit = filteredOperations.reduce((sum, op) => sum + op.netProfit, 0);
        const splitProfit = totalProfit > 0 ? totalProfit * 0.5 : 0;
        
        splitProfitElement.textContent = formatCurrency(splitProfit);
    };

    const toggleDarkMode = () => {
      document.body.classList.toggle('light-mode');
    };
    
    const toggleOperationsHistory = () => {
        const content = document.getElementById('operations-history-content');
        const button = document.getElementById('toggle-history-btn');
        const isVisible = content.style.display !== 'none';
        
        if (isVisible) {
            content.style.display = 'none';
            button.textContent = 'Mostrar';
            showNotification('Historial de operaciones oculto.', 'warning');
        } else {
            content.style.display = 'block';
            button.textContent = 'Ocultar';
            showNotification('Historial de operaciones visible.', 'success');
        }
    };
    
    const renderCharts = () => {
      const operations = loadData(STORAGE_KEYS.operations);
      
      if (profitChart) profitChart.destroy();
      const dailySummary = operations.sort((a,b) => new Date(a.date) - new Date(b.date)).reduce((acc, op) => {
        if (!acc[op.date]) {
          acc[op.date] = 0;
        }
        acc[op.date] += op.netProfit;
        return acc;
      }, {});
      const profitData = {
        labels: Object.keys(dailySummary),
        datasets: [{
          label: 'Ganancia Diaria Neta',
          data: Object.values(dailySummary),
          backgroundColor: (context) => {
              const value = context.dataset.data[context.dataIndex];
              return value >= 0 ? 'rgba(16, 185, 129, 0.6)' : 'rgba(239, 68, 68, 0.6)';
          },
          borderColor: (context) => {
              const value = context.dataset.data[context.dataIndex];
              return value >= 0 ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 1)';
          },
          borderWidth: 1,
          tension: 0.3,
          fill: true
        }]
      };
      const profitConfig = {
        type: 'line',
        data: profitData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Ganancia Neta ($)',
                color: 'var(--text-light)'
              },
              grid: {
                color: 'var(--border)'
              },
              ticks: {
                color: 'var(--text-light)'
              }
            },
            x: {
              grid: {
                color: 'var(--border)'
              },
              ticks: {
                color: 'var(--text-light)'
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: 'var(--text)'
              }
            }
          }
        }
      };
      profitChart = new Chart(document.getElementById('profitChart'), profitConfig);
      
      if (monthlyChart) monthlyChart.destroy();
      const monthlySummary = operations.reduce((acc, op) => {
        const month = op.date.slice(0, 7);
        if (!acc[month]) {
          acc[month] = 0;
        }
        acc[month] += op.netProfit;
        return acc;
      }, {});
      
      const monthlyData = {
          labels: Object.keys(monthlySummary),
          datasets: [{
              label: 'Ganancia Mensual Neta',
              data: Object.values(monthlySummary),
              backgroundColor: 'rgba(90, 103, 216, 0.6)',
              borderColor: 'rgba(90, 103, 216, 1)',
              borderWidth: 2,
              type: 'bar'
          }, {
              label: 'Capital Acumulado',
              data: Object.values(monthlySummary).reduce((acc, current) => {
                  const last = acc.length > 0 ? acc[acc.length - 1] : 0;
                  acc.push(last + current);
                  return acc;
              }, []),
              borderColor: 'rgba(72, 187, 120, 1)',
              backgroundColor: 'rgba(72, 187, 120, 0.2)',
              type: 'line',
              tension: 0.4,
              fill: true,
              yAxisID: 'y1'
          }]
      };

      const monthlyConfig = {
          type: 'bar',
          data: monthlyData,
          options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                  mode: 'index',
                  intersect: false,
              },
              scales: {
                  y: {
                      type: 'linear',
                      display: true,
                      position: 'left',
                      title: {
                          display: true,
                          text: 'Ganancia Mensual ($)',
                          color: 'var(--text-light)'
                      },
                      grid: {
                        color: 'var(--border)'
                      },
                      ticks: {
                        color: 'var(--text-light)'
                      }
                  },
                  y1: {
                      type: 'linear',
                      display: true,
                      position: 'right',
                      grid: {
                          drawOnChartArea: false,
                          color: 'var(--border)'
                      },
                      title: {
                          display: true,
                          text: 'Capital Acumulado ($)',
                          color: 'var(--text-light)'
                      },
                      ticks: {
                        color: 'var(--text-light)'
                      }
                  },
                  x: {
                    grid: {
                      color: 'var(--border)'
                    },
                    ticks: {
                      color: 'var(--text-light)'
                    }
                  }
              },
              plugins: {
                legend: {
                  labels: {
                    color: 'var(--text)'
                  }
                }
              }
          }
      };
      monthlyChart = new Chart(document.getElementById('monthlyChart'), monthlyConfig);
    };

    const showCalculator = () => {
        const calculator = document.getElementById('calculator-widget');
        const isVisible = calculator.style.display === 'block';
        calculator.style.display = isVisible ? 'none' : 'block';
    };

    const refreshAll = () => {
        updateAccountSelects();
        recalculateAccountBalances();
        updateGlobalStats();
        renderAccountStatsSummary();
        renderDailyOperations();
        applyFilters(); 
        renderCharts();
        updateSplitProfitCard();
    };

    document.getElementById('csv-input').addEventListener('change', importFromCSV);
    document.getElementById('filter-account').addEventListener('change', applyFilters);
    document.getElementById('filter-start').addEventListener('change', applyFilters);
    document.getElementById('filter-end').addEventListener('change', applyFilters);
    
    document.addEventListener('DOMContentLoaded', () => {
        migrateData();
        clearOperationForm(); 
        refreshAll();
    });
    
  </script>
</body>
</html>